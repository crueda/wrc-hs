<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Google Maps Sliding Marker Move Demo</title>

    <link href="./demo/map.css" rel="stylesheet" />

    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script src="./vendor/jquery.easing.1.3.js"></script>
    <script src="./vendor/markerAnimate.js"></script>
    <script src="./SlidingMarker.js"></script>

    <script>

        //SlidingMarker.initializeGlobally();
        var marker, map;

        function initialize() {
            //var myLatlng = new google.maps.LatLng(60.0277, 13.6968);
            var myLatlng = new google.maps.LatLng(44.5412, 6.0608);
            var mapOptions = {
                zoom: 11,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

            var sueciaLayer = new google.maps.KmlLayer({
                url: 'https://dl.dropboxusercontent.com/u/2387761/kml/suecia.kmz',
                map: map
              });
            var monteViernesLayer = new google.maps.KmlLayer({
                url: 'https://dl.dropboxusercontent.com/u/2387761/kml/monte_viernes.kml',
                map: map
              });
            var monteSabadoLayer = new google.maps.KmlLayer({
                url: 'https://dl.dropboxusercontent.com/u/2387761/kml/monte_sabado.kml',
                map: map
              });


            $.getJSON( "../tracking_wrc.json", function( data ) {
               var items = [];
               $.each( data, function( key, val ) {
                 add (val.properties.license,val.properties.alias,val.geometry.coordinates[0],val.geometry.coordinates[1],val.properties.tracking_state,val.properties.vehicle_state);
                 dict[val.properties.license] = [val.geometry.coordinates[0],val.geometry.coordinates[1]];

             });                    
           });          
        }

        ///////////////////////////////////////////////////

        $(function () {
            initialize();
        });

    </script>

    <script>
        window.onload = function() { setInterval(reloadLayer,2000)};
    </script>

    <script type="text/javascript">    
       var dict = {};
       var marker = [];
       var car = null;
    </script>

</head>
<body>
    <div id="map_canvas"></div>
    <script>
    function add(ident, alias, lon, lat, tracking_state, vehicle_state) {
        var myLatlng = new google.maps.LatLng(lat, lon);
        var image = '../img/OnStage/FiaOnStage' + ident + '.png';

         var icon = new google.maps.MarkerImage(image, new google.maps.Size(30,30), 
            null, new google.maps.Point(15, 15), 
            new google.maps.Size(30, 30));
        
        marker[ident] = new SlidingMarker({
            position: myLatlng,
            map: map,
            icon: icon,
            title: alias
        });
        
       
    }

 
    function reloadLayer() {
        $.getJSON( "../tracking_wrc.json", function( data ) {
            $.each( data, function( key, val ) {
                check (val.properties.license,val.properties.alias,val.geometry.coordinates[0],val.geometry.coordinates[1],val.properties.tracking_state,val.properties.vehicle_state);
            });               
        });
    }

    function check(ident,alias,lon,lat,tracking_state,vehicle_state) { 
    if (iden='030') {
        var a=1;
    }  
        if (dict[ident][0] != lon) 
        //if (dict[ident][0] != lon  || dict[ident][1] != lat) 
        {            
            //marker[ident].setVisible(false);
            //add(ident, alias, lon, lat, tracking_state, vehicle_state);

            
            var myLatlng = new google.maps.LatLng(lat, lon);
            var duration = parseInt(2000);
            marker[ident].setDuration(duration);
            marker[ident].setEasing("linear");
            marker[ident].setPosition(myLatlng);
            
        }
    }

    </script>

</body>
</html>