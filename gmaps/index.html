<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Google Maps Sliding Marker Move Demo</title>

    <link href="./demo/map.css" rel="stylesheet" />

    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script src="./vendor/jquery.easing.1.3.js"></script>
    <script src="./vendor/markerAnimate.js"></script>
    <script src="./SlidingMarker.js"></script>

    <script>

        //SlidingMarker.initializeGlobally();
        var marker, map;

        function initialize() {
            var myLatlng = new google.maps.LatLng(60.0277, 13.6968);
            var mapOptions = {
                zoom: 11,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

            var sueciaLayer = new google.maps.KmlLayer({
                url: 'https://dl.dropboxusercontent.com/u/2387761/kml/suecia.kmz',
                map: map
              });

            $.getJSON( "../tracking_wrc.json", function( data ) {
               var items = [];
               $.each( data, function( key, val ) {
                 add (val.properties.license,val.properties.alias,val.geometry.coordinates[0],val.geometry.coordinates[1],val.properties.tracking_state,val.properties.vehicle_state);
                 dict[val.properties.license] = [val.geometry.coordinates[0],val.geometry.coordinates[1]];

             });                    
           });          
        }

        ///////////////////////////////////////////////////

        $(function () {
            initialize();

            google.maps.event.addListener(map, 'click', function (event) {
                var duration = parseInt(2000);
                marker.setDuration(duration);
                marker.setEasing("linear");

                marker.setPosition(event.latLng);
            });
        });

    </script>

    <script>
        window.onload = function() { setInterval(reloadLayer,1000)};
    </script>

    <script type="text/javascript">    
       var dict = {};
       var marker = [];
       var car = null;
    </script>

</head>
<body>
    <div id="map_canvas"></div>
    <script>
    function add(ident, alias, lon, lat, tracking_state, vehicle_state) {
        var myLatlng = new google.maps.LatLng(lat, lon);
        marker[ident] = new SlidingMarker({
            position: myLatlng,
            map: map,
            title: alias
        });
    }

    function reloadLayer() {
        $.getJSON( "../tracking_wrc.json", function( data ) {
            $.each( data, function( key, val ) {
                check (val.properties.license,val.properties.alias,val.geometry.coordinates[0],val.geometry.coordinates[1],val.properties.tracking_state,val.properties.vehicle_state);
            });               
        });
    }

    function check(ident,alias,lon,lat,tracking_state,vehicle_state) {   
        if (dict[ident][0] != lon) 
        //if (dict[ident][0] != lon  || dict[ident][1] != lat) 
        {
            var myLatlng = new google.maps.LatLng(lat, lon);
            var duration = parseInt(2000);
            marker[ident].setDuration(duration);
            marker[ident].setEasing("linear");

            marker[ident].setPosition(myLatlng);
        }
    }

    </script>

</body>
</html>