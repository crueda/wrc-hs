<!DOCTYPE html>
<html>
<head>
<title>Earthquakes in KML</title>
<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="http://openlayers.org/en/v3.9.0/css/ol.css" type="text/css">
      <link rel="stylesheet" href="./css/ol3-layerswitcher.css" type="text/css">
<script src="http://openlayers.org/en/v3.9.0/build/ol.js"></script>

      <script src="./js/ol3-layerswitcher.js" type="text/javascript"></script>



<style>
#map {
            position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
}
#info {
  position: absolute;
  height: 1px;
  width: 1px;
  z-index: 100;
}
.tooltip.in {
  opacity: 1;
  filter: alpha(opacity=100);
}
.tooltip.top .tooltip-arrow {
  border-top-color: white;
}
.tooltip-inner {
  border: 2px solid white;
}

</style>

      <script type="text/javascript">    
 
        var dict = {};
      </script>



      <script>
        window.onload = function() { initLayer(); setInterval(reloadLayer,2000)};
      </script>

</head>
<body>
<div class="container-fluid">

<div class="row-fluid">
  <div class="span12">
    <div id="map" class="map"><div id="info"></div></div>
  </div>
</div>

</div>
<script>

var image = new ol.style.Circle({
        radius: 10,
        fill: new ol.style.Fill({
          color: 'rgba(255,0,0,0.2)'
        }),
        stroke: new ol.style.Stroke({color: 'red', width: 0})
      });

      var styles = {
          'Point': [new ol.style.Style({
            image: image
          })],
          'MultiPoint': [new ol.style.Style({
            image: image
          })],        
          'Circle': [new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'red',
              width: 2
            }),
            fill: new ol.style.Fill({
              color: 'rgba(255,0,0,0.2)'
            })
          })]
      };

      var styleFunction = function(feature, resolution) {
          return styles[feature.getGeometry().getType()];
      };

      var allFeatures = [];

      var vectorSource = new ol.source.Vector({
        features: allFeatures
      });

      var vectorLayer = new ol.layer.Vector({
        title: 'Tracking WRC & WRC2',
        style: styles,
        source: vectorSource
      });

      var projection = ol.proj.get('EPSG:3857');
      
var vectorKmlRally = new ol.layer.Vector({
                                    title: 'Sweden 2016',
                                  visible: true,

  source: new ol.source.Vector({
    url: './kml/rally2.kml',
    format: new ol.format.KML()
  })
});


function add(ident, lon, lat, tracking_state, vehicle_state) {
      var geo_point = new ol.geom.Point(ol.proj.transform([lon, lat], 'EPSG:4326',     
        'EPSG:3857'));

      var iconFeature = new ol.Feature({
         geometry: geo_point,
         name: ident
      });

     if (vehicle_state ==  "VEHICLE_STOPPED") {
        var iconStyle = new ol.style.Style({
         image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          scale: 1,
          src: 'img/Stop/FiaStop'+ident+'.png'
         }))
        });
      }
      else if (vehicle_state ==  "YELLOW_FLAG_CONFIRM") {
        var iconStyle = new ol.style.Style({
         image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          scale: 0.8,
          src: 'img/YellowFlagConfirm/FiaYellowFlagConfirm'+ident+'.png'
         }))
        });        
      }
      else {
        var iconStyle = new ol.style.Style({
         image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          scale: 1,
          src: 'img/OnStage/FiaOnStage'+ident+'.png'
         }))
        });
      }

      iconFeature.setStyle(iconStyle);
      iconFeature.setId(ident);
            
      vectorSource.addFeature(iconFeature);
    }

        

    function initLayer() {
      $.getJSON( "tracking_wrc.json", function( data ) {
        var items = [];
          $.each( data, function( key, val ) {
              add (val.properties.name,val.geometry.coordinates[0],val.geometry.coordinates[1],val.properties.tracking_state,val.properties.vehicle_state);
              dict[val.properties.name] = [val.geometry.coordinates[0],val.geometry.coordinates[1]];
          });                    
        });          
    }
    
    function reloadLayer() {
      $.getJSON( "tracking_wrc.json", function( data ) {
        var items = [];
        $.each( data, function( key, val ) {
          check (val.properties.name,val.geometry.coordinates[0],val.geometry.coordinates[1],val.properties.tracking_state,val.properties.vehicle_state);
        });               
      });
    }

    function check(ident,lon,lat,tracking_state,vehicle_state) {
      
      //if (ident == '001') {
        //alert (dict[ident][0]);
      //}


      if (dict[ident][0] != lon) 
      //if (dict[ident][0] != lon  ||Â dict[ident][1] != lat) 
        {
          iFeature = vectorSource.getFeatureById(ident);
          if (iFeature!=null) {
            vectorSource.removeFeature(iFeature);
            add (ident,lon,lat,tracking_state,vehicle_state);
          }
        }

        
      }



var toner = new ol.layer.Tile({
                                  title: 'Toner',
                                  type: 'base',
                                  visible: false,
  source: new ol.source.Stamen({
    layer: 'toner'
  })
});

var roads = new ol.layer.Tile({
                                  title: 'Roads',
                                  type: 'base',
                                  visible: true,
                                  source: new ol.source.XYZ({
                                      url: 'http://1.maptile.lbs.ovi.com/maptiler/v2/maptile/newest/normal.day/{z}/{x}/{y}/256/png8?lg=es&app_id=XauXjbuily9soJuafQ8d&token=qg4GasqCW0lTKZbyeID3_A'
                                  })
});


var sat = new ol.layer.Tile({
                            title: 'MapQuest Aereal',
                            type: 'base',
                            visible: false,
                            source: new ol.source.MapQuest({layer: 'sat'})
                        
});


var osm = new ol.layer.Tile({
                            title: 'OpenStreetMap',
                            type: 'base',
                            visible: false,
                            source: new ol.source.OSM()
                        });


/*
var mapbox_aereal = new ol.layer.Tile({
                            title: 'Mapbox Aereal',
                            type: 'base',
                            visible: false,
                            source: new ol.source.MapQuest({layer: 'sat'})
                        })
});*/


  //toner, roads, vectorLayer, vectorKmlRally

var map = new ol.Map({
  layers: [

 new ol.layer.Group({
                'title': 'Base maps',
                layers: [

  toner, roads, sat, osm


  ]
                  }),
 

 new ol.layer.Group({
                'title': 'WRC',
                layers: [vectorLayer, vectorKmlRally
  ]
                  })

],
  //layers: [raster, vectorLayer],
  target: 'map',
  view: new ol.View({
    //center: [4.3, 42.4],
    //zoom: 6
    center: [-4, 41],
    zoom: 4
  })
});

/*
if(navigator.geolocation) {
            browserSupportFlag = true;
            navigator.geolocation.getCurrentPosition(
            function(position) {    
              var new_view = new ol.View({

                //center: ol.proj.transform([13.56, 59.89], 'EPSG:4326', 'EPSG:3857'),
                center: ol.proj.transform([position.coords.longitude, position.coords.latitude], 'EPSG:4326', 'EPSG:3857'),
                zoom: 4,
                minZoom: 2,
                maxZoom: 19

              });
            });
            map.setView(new_view);
          }

*/
        var layerSwitcher = new ol.control.LayerSwitcher({
                    tipLabel: 'Capas' // Optional label for button
        });
        map.addControl(layerSwitcher);
        map.addControl(new ol.control.FullScreen());



       //if(navigator.geolocation) {
            browserSupportFlag = true;
            navigator.geolocation.getCurrentPosition(
            function(position) {    
              var new_view = new ol.View({
                //center: ol.proj.transform([position.coords.longitude, position.coords.latitude], 'EPSG:4326', 'EPSG:900913'),


                center: ol.proj.transform([13.56, 59.89], 'EPSG:4326', 'EPSG:3857'),
                //center: ol.proj.transform([position.coords.longitude, position.coords.latitude], 'EPSG:4326', 'EPSG:3857'),
                zoom: 4,
                minZoom: 2,
                maxZoom: 19

              });
              var duration = 2000;
              var start = +new Date();
              var pan = ol.animation.pan({
                duration: duration,
                source:  (map.getView().getCenter()),
                start: start
              });
              var bounce = ol.animation.bounce({
                  duration: duration,
                  resolution: 4 * map.getView().getResolution(),
                  start: start
              });
              map.beforeRender(pan, bounce);

                map.setView(new_view);
              },             
              function() {                
                var new_view = new ol.View({
                  center: ol.proj.transform([defaultLongitude, defaultLatitude], 'EPSG:4326', 'EPSG:3857'),
                  zoom: 11,
                  minZoom: 2,
                  maxZoom: 19
                });
              map.setView(new_view);
              });
        //}


var info = $('#info');
info.tooltip({
  animation: false,
  trigger: 'manual'
});

var displayFeatureInfo = function(pixel) {
  info.css({
    left: pixel[0] + 'px',
    top: (pixel[1] - 15) + 'px'
  });
  var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
    return feature;
  });
  if (feature) {
    //alert(feature.get('name'));
    info.tooltip('hide')
        .attr('data-original-title', feature.get('name'))
        .tooltip('fixTitle')
        .tooltip('show');
  } else {
    info.tooltip('hide');
  }
};

map.on('pointermove', function(evt) {
  if (evt.dragging) {
    info.tooltip('hide');
    return;
  }
  displayFeatureInfo(map.getEventPixel(evt.originalEvent));
});

map.on('click', function(evt) {
  displayFeatureInfo(evt.pixel);
});

</script>
</body>
</html>